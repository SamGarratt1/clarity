<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Clarity Assistant • Chat</title>
  <link rel="stylesheet" href="/style.css?v=4"/>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="brand" href="/">Clarity Health Concierge</a>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
      </nav>
    </div>
  </header>

  <div class="container chat-shell">
    <div class="chat-card">
      <div class="chat-head">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="badge">Assistant online</div>
          <div class="small">Triage & booking</div>
        </div>
        <div class="lang-row" id="lang-row"></div>
      </div>

      <div id="stream" class="chat-body" aria-live="polite"></div>

      <div class="toolrow">
        <button data-quick="Start">Start</button>
        <button data-quick="My clinic">My clinic</button>
        <button data-quick="Nearby">Nearby</button>
        <button data-quick="HELP">HELP</button>
      </div>

      <div class="chat-input">
        <input id="chat-input" class="input" placeholder="Type a message…"/>
        <button id="chat-send" class="send">Send</button>
      </div>
    </div>
    <div class="helper small">Tip: say <em>ASAP</em> for the earliest slot. You can also text our toll-free number.</div>
  </div>

  <script>
    // ===== Set your backend URL (Render) =====
    const BACKEND_BASE = 'https://clarity-mo5i.onrender.com'; // change me
    // ========================================

    const API_BASE = (new URLSearchParams(location.search).get('api') || BACKEND_BASE).replace(/\/$/,'');
    const SID_KEY='clarity.sid'; const sid = localStorage.getItem(SID_KEY)||crypto.randomUUID(); localStorage.setItem(SID_KEY,sid);

    const LANGS=[
      {code:'en',label:'English'},{code:'es',label:'Español'},{code:'fr',label:'Français'},
      {code:'pt',label:'Português'},{code:'ar',label:'العربية'},{code:'zh',label:'中文'},{code:'hi',label:'हिन्दी'}
    ];
    let currentLang=localStorage.getItem('clarity.lang')||'en';

    const stream=document.getElementById('stream'), input=document.getElementById('chat-input'), sendBtn=document.getElementById('chat-send');

    // Build language buttons
    const langRow=document.getElementById('lang-row');
    function renderLang(){
      langRow.innerHTML='';
      LANGS.forEach(l=>{
        const b=document.createElement('button'); b.textContent=l.label;
        if(l.code===currentLang) b.classList.add('active');
        b.onclick=()=>{ currentLang=l.code; localStorage.setItem('clarity.lang',currentLang); renderLang(); addSys(`Language set to ${l.label}.`); };
        langRow.appendChild(b);
      });
    }
    renderLang();

    function el(t,c){const x=document.createElement(t); if(c) x.className=c; return x;}
    function addMsg(who,text,isYou=false){
      const row=el('div','msg'+(isYou?' you':'')), w=el('div','who'); w.textContent=isYou?'You':'Assistant';
      const b=el('div','bubble'); b.innerHTML=(text||'').toString().replace(/\n/g,'<br>');
      row.append(w,b); stream.append(row); stream.scrollTop=stream.scrollHeight;
    }
    function addSys(t){ addMsg('sys', `<span class="small">${t}</span>`); }

    document.querySelectorAll('[data-quick]').forEach(b=> b.onclick=()=>{ input.value=b.dataset.quick; input.focus(); });

    async function sendText(text){
      const clean=(text||'').toString().slice(0,2000); if(!clean) return;
      addMsg('you', clean, true); input.value='';
      const payload={from:'web',text:clean,sid,lang:currentLang};

      const urls=[`${API_BASE}/webchat`,`${API_BASE}/chat`];
      let data=null,last=null;
      for(const u of urls){
        try{
          const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          if(r.ok){ data=await r.json(); break; } last=await r.text();
        }catch(e){ last=e.message; }
      }
      if(!data){ addMsg('assistant',`Server error: <code>${(last||'unknown')}</code>`); return; }

      const replies = Array.isArray(data.replies)?data.replies:(data.reply?[data.reply]:[]);
      if(!replies.length){ addMsg('assistant','No response received.'); return; }
      for(const m of replies) addMsg('assistant', m);
    }
    function doSend(){ sendText(input.value); }
    sendBtn.onclick=doSend; input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); doSend(); }});

    addMsg('assistant','Welcome to Clarity — I’ll grab the details and book for you. Type <strong>Start</strong> to begin, or choose your language above.');
  </script>
</body>
</html>
